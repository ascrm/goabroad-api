# 社区模块 - 发布帖子接口实现说明

## 📋 实现概述

已完成社区模块的"发布帖子"接口实现，**严格符合**`GoAbroad API 接口文档.md`中的规范定义。

**实现日期**: 2024-10-28  
**接口路径**: `POST /api/community/posts` ✅  
**需要认证**: 是（使用Sa-Token）

---

## ✅ 修正说明

根据`社区模块修改说明.md`的要求，已完成以下修正：

### 修改前 ❌
```java
@RestController
@RequestMapping("/api/posts")  // ❌ 不符合接口文档
@Tag(name = "社区模块 - 帖子管理")
public class PostController {
    @PostMapping  // 实际路径: POST /api/posts
}
```

### 修改后 ✅
```java
@RestController
@RequestMapping("/api/community")  // ✅ 符合接口文档
@Tag(name = "社区模块")
public class CommunityController {
    @PostMapping("/posts")  // 实际路径: POST /api/community/posts
}
```

**修改内容**：
1. ✅ Controller 重命名：`PostController` → `CommunityController`
2. ✅ 接口路径修正：`/api/posts` → `/api/community`
3. ✅ 方法映射调整：`@PostMapping` → `@PostMapping("/posts")`
4. ✅ Swagger标签更新：更清晰的模块描述

---

## 📁 已创建的文件

### 1. DTO（数据传输对象）

#### CreatePostDto.java
- **路径**: `goabroad-model/src/main/java/com/goabroad/model/dto/CreatePostDto.java`
- **功能**: 发布帖子请求参数封装
- **字段**:
  - `contentType`: 内容类型（POST/QUESTION/TIMELINE/VLOG）
  - `title`: 标题（必填，1-200字）
  - `content`: 内容（必填，Markdown格式，1-50000字）
  - `status`: 发布状态（DRAFT/PUBLISHED，默认PUBLISHED）
  - `coverImage`: 封面图片URL
  - `images`: 图片URL列表
  - `videos`: 视频URL列表
  - `tags`: 标签列表
  - `country`: 国家代码
  - `stage`: 阶段标签

### 2. VO（视图对象）

#### PostDetailVo.java
- **路径**: `goabroad-model/src/main/java/com/goabroad/model/vo/PostDetailVo.java`
- **功能**: 帖子详情响应数据封装
- **主要字段**:
  - 帖子基本信息（id、title、content等）
  - 作者信息（AuthorVo内部类）
  - 统计数据（点赞数、评论数、浏览数等）
  - 状态标识（isLiked、isCollected等）
  - 时间信息（createdAt、updatedAt）

### 3. Repository（数据访问层）

#### PostRepository.java
- **路径**: `goabroad-service/src/main/java/com/goabroad/service/community/post/repository/PostRepository.java` ✅
- **包名**: `com.goabroad.service.community.post.repository`
- **功能**: 帖子数据访问接口
- **方法**: 
  - `findByIdAndDeleted()`: 根据ID和删除状态查询帖子

### 4. Service（业务逻辑层）

#### PostService.java
- **路径**: `goabroad-service/src/main/java/com/goabroad/service/community/post/service/PostService.java` ✅
- **包名**: `com.goabroad.service.community.post.service`
- **功能**: 帖子服务接口
- **方法**:
  - `createPost()`: 发布帖子

#### PostServiceImpl.java
- **路径**: `goabroad-service/src/main/java/com/goabroad/service/community/post/service/impl/PostServiceImpl.java` ✅
- **包名**: `com.goabroad.service.community.post.service.impl`
- **功能**: 帖子服务实现类
- **核心逻辑**:
  1. 验证用户是否存在
  2. 合并图片和视频到mediaUrls字段
  3. 构建Post实体并保存到数据库
  4. 如果是已发布状态，更新用户的发帖数
  5. 转换为PostDetailVo并返回

### 5. Controller（控制器层）

#### CommunityController.java ✅
- **路径**: `goabroad-web/src/main/java/com/goabroad/web/controller/CommunityController.java`
- **功能**: 社区模块控制器
- **接口**:
  - `POST /api/community/posts`: 发布帖子

### 6. Entity更新

#### Post.java
- **更新**: 添加了`tagsJson`字段用于存储标签JSON数据
- **说明**: 用于快速读取标签，完整的标签关系在post_tags表中

---

## 🔧 技术实现细节

### 接口路径对比

| 模块 | Controller | 接口路径 | 符合标准 |
|------|-----------|---------|---------|
| 认证模块 | `AuthController` | `/api/auth` | ✅ |
| 用户模块 | `UserController` | `/api/users` | ✅ |
| 文件模块 | `FileController` | `/api/files` | ✅ |
| **社区模块** | `CommunityController` | `/api/community` | ✅ |

### 字段映射

由于数据库表设计与API文档略有差异，做了以下映射：

| API字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| country | country_code | 国家代码 |
| stage | category | 阶段标签 |
| images + videos | media_urls (JSONB) | 图片和视频统一存储 |
| tags | tags_json (TEXT) | 标签JSON字符串 |
| userId | author_id | 作者ID |

### 业务逻辑

1. **用户验证**: 通过UserRepository查询用户是否存在
2. **媒体合并**: 将images和videos合并到mediaUrls列表
3. **标签处理**: 将标签列表转换为JSON字符串存储
4. **发帖数更新**: 如果是已发布状态，自动增加用户的发帖计数
5. **徽章生成**: 根据用户等级和发帖数动态生成徽章
6. **国家名称**: 临时硬编码常见国家名称（待国家模块实现后从数据库查询）

### 默认值设置

- 状态: 默认为PUBLISHED（已发布）
- 统计数据: likeCount、commentCount、viewCount等初始为0
- 标识: isPinned、isFeatured、isHot初始为false
- 权限: allowComment默认为true
- 发布时间: 如果是已发布状态，自动设置publishedAt为当前时间

---

## 📝 API使用示例

### 请求示例

```bash
POST /api/community/posts
Authorization: Bearer {token}
Content-Type: application/json

{
  "contentType": "POST",
  "title": "美国F1签证面签经验分享",
  "content": "# 前言\n\n今天刚刚通过面签，分享一下经验...",
  "status": "PUBLISHED",
  "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
  "images": [
    "https://cdn.goabroad.com/posts/img1.jpg",
    "https://cdn.goabroad.com/posts/img2.jpg"
  ],
  "videos": [],
  "tags": ["美国", "签证", "F1", "面签经验"],
  "country": "US",
  "stage": "签证办理"
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "发布成功",
  "data": {
    "id": 1,
    "author": {
      "id": 1,
      "username": "user_123",
      "nickname": "GoAbroad小新",
      "avatarUrl": "https://...",
      "bio": "正在准备美国留学",
      "level": 5,
      "badges": ["活跃用户"],
      "isFollowing": false
    },
    "contentType": "POST",
    "title": "美国F1签证面签经验分享",
    "content": "# 前言\n\n今天刚刚通过面签...",
    "status": "PUBLISHED",
    "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
    "images": ["https://cdn.goabroad.com/posts/img1.jpg"],
    "videos": [],
    "tags": ["美国", "签证", "F1"],
    "country": "US",
    "countryName": "美国",
    "stage": "签证办理",
    "likeCount": 0,
    "commentCount": 0,
    "collectCount": 0,
    "viewCount": 0,
    "isLiked": false,
    "isCollected": false,
    "isPinned": false,
    "isFeatured": false,
    "createdAt": "2024-10-28T10:00:00",
    "updatedAt": "2024-10-28T10:00:00"
  },
  "timestamp": 1698345600000
}
```

### Swagger UI 测试

访问: `http://localhost:8080/swagger-ui/index.html`

在Swagger文档中查找：
- **分组**: "社区模块"
- **接口**: `POST /api/community/posts` - 发布帖子

---

## ⚠️ 注意事项

### 待优化项

1. **标签处理**: 当前将标签存储为JSON字符串，后续可实现：
   - 标签自动创建（tags表）
   - 建立关联关系（post_tags表）
   - 标签热度统计

2. **国家名称**: 当前使用硬编码，待国家模块实现后应从countries表查询

3. **媒体区分**: 当前将所有媒体URL存储在mediaUrls中，返回时未区分图片和视频

4. **内容审核**: 未实现敏感词过滤，建议后续添加

5. **摘要生成**: 未实现自动摘要提取

### 依赖关系

- 依赖`UserRepository`查询用户信息
- 依赖`Sa-Token`进行用户认证
- 使用`Hutool`的JSONUtil进行JSON处理

---

## 🎯 模块扩展性

按照当前的`CommunityController`设计，未来可以轻松扩展以下功能：

```java
@RestController
@RequestMapping("/api/community")
public class CommunityController {
    
    // 帖子相关
    @PostMapping("/posts")                        // ✅ 已实现
    @GetMapping("/posts")                         // 待实现
    @GetMapping("/posts/{postId}")                // 待实现
    @PutMapping("/posts/{postId}")                // 待实现
    @DeleteMapping("/posts/{postId}")             // 待实现
    @PostMapping("/posts/{postId}/like")          // 待实现
    @PostMapping("/posts/{postId}/collect")       // 待实现
    
    // 评论相关
    @GetMapping("/posts/{postId}/comments")       // 待实现
    @PostMapping("/posts/{postId}/comments")      // 待实现
    @DeleteMapping("/posts/{postId}/comments/{commentId}")  // 待实现
    
    // 举报相关
    @PostMapping("/reports")                      // 待实现
}
```

---

## ✅ 完成状态

- [x] 创建 CreatePostDto
- [x] 创建 PostDetailVo
- [x] 创建 PostRepository
- [x] 创建 PostService 和 PostServiceImpl
- [x] 创建 CommunityController（修正）
- [x] 更新 Post 实体类
- [x] 修正接口路径为 `/api/community`
- [x] 字段映射适配
- [x] 业务逻辑实现
- [x] 错误处理
- [x] 日志记录
- [x] API文档注释

---

## 📊 数据库影响

### 涉及的表

1. **posts**: 插入新帖子记录
2. **users**: 更新发帖数（post_count字段）

### SQL示例

```sql
-- 插入帖子
INSERT INTO posts (
    author_id, title, content, content_type, status,
    cover_image, media_urls, tags_json, country_code, category,
    like_count, comment_count, collect_count, view_count,
    is_pinned, is_featured, is_hot, allow_comment,
    published_at, created_at, updated_at, deleted
) VALUES (...);

-- 更新用户发帖数
UPDATE users SET post_count = post_count + 1 WHERE id = ?;
```

---

**实现者**: AI Assistant  
**版本**: v2.0（已修正）  
**文档更新**: 2024-10-28

**修正说明**: 
- 根据`社区模块修改说明.md`的要求修正了接口路径
- Controller从`PostController`重命名为`CommunityController`
- 接口路径从`/api/posts`改为`/api/community/posts`
- 现在完全符合API接口文档的规范 ✅

