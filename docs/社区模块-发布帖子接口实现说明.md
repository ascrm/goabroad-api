# ç¤¾åŒºæ¨¡å— - å‘å¸ƒå¸–å­æ¥å£å®ç°è¯´æ˜

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²å®Œæˆç¤¾åŒºæ¨¡å—çš„"å‘å¸ƒå¸–å­"æ¥å£å®ç°ï¼Œ**ä¸¥æ ¼ç¬¦åˆ**`GoAbroad API æ¥å£æ–‡æ¡£.md`ä¸­çš„è§„èŒƒå®šä¹‰ã€‚

**å®ç°æ—¥æœŸ**: 2024-10-28  
**æ¥å£è·¯å¾„**: `POST /api/community/posts` âœ…  
**éœ€è¦è®¤è¯**: æ˜¯ï¼ˆä½¿ç”¨Sa-Tokenï¼‰

---

## âœ… ä¿®æ­£è¯´æ˜

æ ¹æ®`ç¤¾åŒºæ¨¡å—ä¿®æ”¹è¯´æ˜.md`çš„è¦æ±‚ï¼Œå·²å®Œæˆä»¥ä¸‹ä¿®æ­£ï¼š

### ä¿®æ”¹å‰ âŒ
```java
@RestController
@RequestMapping("/api/posts")  // âŒ ä¸ç¬¦åˆæ¥å£æ–‡æ¡£
@Tag(name = "ç¤¾åŒºæ¨¡å— - å¸–å­ç®¡ç†")
public class PostController {
    @PostMapping  // å®é™…è·¯å¾„: POST /api/posts
}
```

### ä¿®æ”¹å âœ…
```java
@RestController
@RequestMapping("/api/community")  // âœ… ç¬¦åˆæ¥å£æ–‡æ¡£
@Tag(name = "ç¤¾åŒºæ¨¡å—")
public class CommunityController {
    @PostMapping("/posts")  // å®é™…è·¯å¾„: POST /api/community/posts
}
```

**ä¿®æ”¹å†…å®¹**ï¼š
1. âœ… Controller é‡å‘½åï¼š`PostController` â†’ `CommunityController`
2. âœ… æ¥å£è·¯å¾„ä¿®æ­£ï¼š`/api/posts` â†’ `/api/community`
3. âœ… æ–¹æ³•æ˜ å°„è°ƒæ•´ï¼š`@PostMapping` â†’ `@PostMapping("/posts")`
4. âœ… Swaggeræ ‡ç­¾æ›´æ–°ï¼šæ›´æ¸…æ™°çš„æ¨¡å—æè¿°

---

## ğŸ“ å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰

#### CreatePostDto.java
- **è·¯å¾„**: `goabroad-model/src/main/java/com/goabroad/model/dto/CreatePostDto.java`
- **åŠŸèƒ½**: å‘å¸ƒå¸–å­è¯·æ±‚å‚æ•°å°è£…
- **å­—æ®µ**:
  - `contentType`: å†…å®¹ç±»å‹ï¼ˆPOST/QUESTION/TIMELINE/VLOGï¼‰
  - `title`: æ ‡é¢˜ï¼ˆå¿…å¡«ï¼Œ1-200å­—ï¼‰
  - `content`: å†…å®¹ï¼ˆå¿…å¡«ï¼ŒMarkdownæ ¼å¼ï¼Œ1-50000å­—ï¼‰
  - `status`: å‘å¸ƒçŠ¶æ€ï¼ˆDRAFT/PUBLISHEDï¼Œé»˜è®¤PUBLISHEDï¼‰
  - `coverImage`: å°é¢å›¾ç‰‡URL
  - `images`: å›¾ç‰‡URLåˆ—è¡¨
  - `videos`: è§†é¢‘URLåˆ—è¡¨
  - `tags`: æ ‡ç­¾åˆ—è¡¨
  - `country`: å›½å®¶ä»£ç 
  - `stage`: é˜¶æ®µæ ‡ç­¾

### 2. VOï¼ˆè§†å›¾å¯¹è±¡ï¼‰

#### PostDetailVo.java
- **è·¯å¾„**: `goabroad-model/src/main/java/com/goabroad/model/vo/PostDetailVo.java`
- **åŠŸèƒ½**: å¸–å­è¯¦æƒ…å“åº”æ•°æ®å°è£…
- **ä¸»è¦å­—æ®µ**:
  - å¸–å­åŸºæœ¬ä¿¡æ¯ï¼ˆidã€titleã€contentç­‰ï¼‰
  - ä½œè€…ä¿¡æ¯ï¼ˆAuthorVoå†…éƒ¨ç±»ï¼‰
  - ç»Ÿè®¡æ•°æ®ï¼ˆç‚¹èµæ•°ã€è¯„è®ºæ•°ã€æµè§ˆæ•°ç­‰ï¼‰
  - çŠ¶æ€æ ‡è¯†ï¼ˆisLikedã€isCollectedç­‰ï¼‰
  - æ—¶é—´ä¿¡æ¯ï¼ˆcreatedAtã€updatedAtï¼‰

### 3. Repositoryï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰

#### PostRepository.java
- **è·¯å¾„**: `goabroad-service/src/main/java/com/goabroad/service/community/post/repository/PostRepository.java` âœ…
- **åŒ…å**: `com.goabroad.service.community.post.repository`
- **åŠŸèƒ½**: å¸–å­æ•°æ®è®¿é—®æ¥å£
- **æ–¹æ³•**: 
  - `findByIdAndDeleted()`: æ ¹æ®IDå’Œåˆ é™¤çŠ¶æ€æŸ¥è¯¢å¸–å­

### 4. Serviceï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰

#### PostService.java
- **è·¯å¾„**: `goabroad-service/src/main/java/com/goabroad/service/community/post/service/PostService.java` âœ…
- **åŒ…å**: `com.goabroad.service.community.post.service`
- **åŠŸèƒ½**: å¸–å­æœåŠ¡æ¥å£
- **æ–¹æ³•**:
  - `createPost()`: å‘å¸ƒå¸–å­

#### PostServiceImpl.java
- **è·¯å¾„**: `goabroad-service/src/main/java/com/goabroad/service/community/post/service/impl/PostServiceImpl.java` âœ…
- **åŒ…å**: `com.goabroad.service.community.post.service.impl`
- **åŠŸèƒ½**: å¸–å­æœåŠ¡å®ç°ç±»
- **æ ¸å¿ƒé€»è¾‘**:
  1. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  2. åˆå¹¶å›¾ç‰‡å’Œè§†é¢‘åˆ°mediaUrlså­—æ®µ
  3. æ„å»ºPostå®ä½“å¹¶ä¿å­˜åˆ°æ•°æ®åº“
  4. å¦‚æœæ˜¯å·²å‘å¸ƒçŠ¶æ€ï¼Œæ›´æ–°ç”¨æˆ·çš„å‘å¸–æ•°
  5. è½¬æ¢ä¸ºPostDetailVoå¹¶è¿”å›

### 5. Controllerï¼ˆæ§åˆ¶å™¨å±‚ï¼‰

#### CommunityController.java âœ…
- **è·¯å¾„**: `goabroad-web/src/main/java/com/goabroad/web/controller/CommunityController.java`
- **åŠŸèƒ½**: ç¤¾åŒºæ¨¡å—æ§åˆ¶å™¨
- **æ¥å£**:
  - `POST /api/community/posts`: å‘å¸ƒå¸–å­

### 6. Entityæ›´æ–°

#### Post.java
- **æ›´æ–°**: æ·»åŠ äº†`tagsJson`å­—æ®µç”¨äºå­˜å‚¨æ ‡ç­¾JSONæ•°æ®
- **è¯´æ˜**: ç”¨äºå¿«é€Ÿè¯»å–æ ‡ç­¾ï¼Œå®Œæ•´çš„æ ‡ç­¾å…³ç³»åœ¨post_tagsè¡¨ä¸­

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ¥å£è·¯å¾„å¯¹æ¯”

| æ¨¡å— | Controller | æ¥å£è·¯å¾„ | ç¬¦åˆæ ‡å‡† |
|------|-----------|---------|---------|
| è®¤è¯æ¨¡å— | `AuthController` | `/api/auth` | âœ… |
| ç”¨æˆ·æ¨¡å— | `UserController` | `/api/users` | âœ… |
| æ–‡ä»¶æ¨¡å— | `FileController` | `/api/files` | âœ… |
| **ç¤¾åŒºæ¨¡å—** | `CommunityController` | `/api/community` | âœ… |

### å­—æ®µæ˜ å°„

ç”±äºæ•°æ®åº“è¡¨è®¾è®¡ä¸APIæ–‡æ¡£ç•¥æœ‰å·®å¼‚ï¼Œåšäº†ä»¥ä¸‹æ˜ å°„ï¼š

| APIå­—æ®µ | æ•°æ®åº“å­—æ®µ | è¯´æ˜ |
|---------|-----------|------|
| country | country_code | å›½å®¶ä»£ç  |
| stage | category | é˜¶æ®µæ ‡ç­¾ |
| images + videos | media_urls (JSONB) | å›¾ç‰‡å’Œè§†é¢‘ç»Ÿä¸€å­˜å‚¨ |
| tags | tags_json (TEXT) | æ ‡ç­¾JSONå­—ç¬¦ä¸² |
| userId | author_id | ä½œè€…ID |

### ä¸šåŠ¡é€»è¾‘

1. **ç”¨æˆ·éªŒè¯**: é€šè¿‡UserRepositoryæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
2. **åª’ä½“åˆå¹¶**: å°†imageså’Œvideosåˆå¹¶åˆ°mediaUrlsåˆ—è¡¨
3. **æ ‡ç­¾å¤„ç†**: å°†æ ‡ç­¾åˆ—è¡¨è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²å­˜å‚¨
4. **å‘å¸–æ•°æ›´æ–°**: å¦‚æœæ˜¯å·²å‘å¸ƒçŠ¶æ€ï¼Œè‡ªåŠ¨å¢åŠ ç”¨æˆ·çš„å‘å¸–è®¡æ•°
5. **å¾½ç« ç”Ÿæˆ**: æ ¹æ®ç”¨æˆ·ç­‰çº§å’Œå‘å¸–æ•°åŠ¨æ€ç”Ÿæˆå¾½ç« 
6. **å›½å®¶åç§°**: ä¸´æ—¶ç¡¬ç¼–ç å¸¸è§å›½å®¶åç§°ï¼ˆå¾…å›½å®¶æ¨¡å—å®ç°åä»æ•°æ®åº“æŸ¥è¯¢ï¼‰

### é»˜è®¤å€¼è®¾ç½®

- çŠ¶æ€: é»˜è®¤ä¸ºPUBLISHEDï¼ˆå·²å‘å¸ƒï¼‰
- ç»Ÿè®¡æ•°æ®: likeCountã€commentCountã€viewCountç­‰åˆå§‹ä¸º0
- æ ‡è¯†: isPinnedã€isFeaturedã€isHotåˆå§‹ä¸ºfalse
- æƒé™: allowCommenté»˜è®¤ä¸ºtrue
- å‘å¸ƒæ—¶é—´: å¦‚æœæ˜¯å·²å‘å¸ƒçŠ¶æ€ï¼Œè‡ªåŠ¨è®¾ç½®publishedAtä¸ºå½“å‰æ—¶é—´

---

## ğŸ“ APIä½¿ç”¨ç¤ºä¾‹

### è¯·æ±‚ç¤ºä¾‹

```bash
POST /api/community/posts
Authorization: Bearer {token}
Content-Type: application/json

{
  "contentType": "POST",
  "title": "ç¾å›½F1ç­¾è¯é¢ç­¾ç»éªŒåˆ†äº«",
  "content": "# å‰è¨€\n\nä»Šå¤©åˆšåˆšé€šè¿‡é¢ç­¾ï¼Œåˆ†äº«ä¸€ä¸‹ç»éªŒ...",
  "status": "PUBLISHED",
  "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
  "images": [
    "https://cdn.goabroad.com/posts/img1.jpg",
    "https://cdn.goabroad.com/posts/img2.jpg"
  ],
  "videos": [],
  "tags": ["ç¾å›½", "ç­¾è¯", "F1", "é¢ç­¾ç»éªŒ"],
  "country": "US",
  "stage": "ç­¾è¯åŠç†"
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "å‘å¸ƒæˆåŠŸ",
  "data": {
    "id": 1,
    "author": {
      "id": 1,
      "username": "user_123",
      "nickname": "GoAbroadå°æ–°",
      "avatarUrl": "https://...",
      "bio": "æ­£åœ¨å‡†å¤‡ç¾å›½ç•™å­¦",
      "level": 5,
      "badges": ["æ´»è·ƒç”¨æˆ·"],
      "isFollowing": false
    },
    "contentType": "POST",
    "title": "ç¾å›½F1ç­¾è¯é¢ç­¾ç»éªŒåˆ†äº«",
    "content": "# å‰è¨€\n\nä»Šå¤©åˆšåˆšé€šè¿‡é¢ç­¾...",
    "status": "PUBLISHED",
    "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
    "images": ["https://cdn.goabroad.com/posts/img1.jpg"],
    "videos": [],
    "tags": ["ç¾å›½", "ç­¾è¯", "F1"],
    "country": "US",
    "countryName": "ç¾å›½",
    "stage": "ç­¾è¯åŠç†",
    "likeCount": 0,
    "commentCount": 0,
    "collectCount": 0,
    "viewCount": 0,
    "isLiked": false,
    "isCollected": false,
    "isPinned": false,
    "isFeatured": false,
    "createdAt": "2024-10-28T10:00:00",
    "updatedAt": "2024-10-28T10:00:00"
  },
  "timestamp": 1698345600000
}
```

### Swagger UI æµ‹è¯•

è®¿é—®: `http://localhost:8080/swagger-ui/index.html`

åœ¨Swaggeræ–‡æ¡£ä¸­æŸ¥æ‰¾ï¼š
- **åˆ†ç»„**: "ç¤¾åŒºæ¨¡å—"
- **æ¥å£**: `POST /api/community/posts` - å‘å¸ƒå¸–å­

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å¾…ä¼˜åŒ–é¡¹

1. **æ ‡ç­¾å¤„ç†**: å½“å‰å°†æ ‡ç­¾å­˜å‚¨ä¸ºJSONå­—ç¬¦ä¸²ï¼Œåç»­å¯å®ç°ï¼š
   - æ ‡ç­¾è‡ªåŠ¨åˆ›å»ºï¼ˆtagsè¡¨ï¼‰
   - å»ºç«‹å…³è”å…³ç³»ï¼ˆpost_tagsè¡¨ï¼‰
   - æ ‡ç­¾çƒ­åº¦ç»Ÿè®¡

2. **å›½å®¶åç§°**: å½“å‰ä½¿ç”¨ç¡¬ç¼–ç ï¼Œå¾…å›½å®¶æ¨¡å—å®ç°ååº”ä»countriesè¡¨æŸ¥è¯¢

3. **åª’ä½“åŒºåˆ†**: å½“å‰å°†æ‰€æœ‰åª’ä½“URLå­˜å‚¨åœ¨mediaUrlsä¸­ï¼Œè¿”å›æ—¶æœªåŒºåˆ†å›¾ç‰‡å’Œè§†é¢‘

4. **å†…å®¹å®¡æ ¸**: æœªå®ç°æ•æ„Ÿè¯è¿‡æ»¤ï¼Œå»ºè®®åç»­æ·»åŠ 

5. **æ‘˜è¦ç”Ÿæˆ**: æœªå®ç°è‡ªåŠ¨æ‘˜è¦æå–

### ä¾èµ–å…³ç³»

- ä¾èµ–`UserRepository`æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- ä¾èµ–`Sa-Token`è¿›è¡Œç”¨æˆ·è®¤è¯
- ä½¿ç”¨`Hutool`çš„JSONUtilè¿›è¡ŒJSONå¤„ç†

---

## ğŸ¯ æ¨¡å—æ‰©å±•æ€§

æŒ‰ç…§å½“å‰çš„`CommunityController`è®¾è®¡ï¼Œæœªæ¥å¯ä»¥è½»æ¾æ‰©å±•ä»¥ä¸‹åŠŸèƒ½ï¼š

```java
@RestController
@RequestMapping("/api/community")
public class CommunityController {
    
    // å¸–å­ç›¸å…³
    @PostMapping("/posts")                        // âœ… å·²å®ç°
    @GetMapping("/posts")                         // å¾…å®ç°
    @GetMapping("/posts/{postId}")                // å¾…å®ç°
    @PutMapping("/posts/{postId}")                // å¾…å®ç°
    @DeleteMapping("/posts/{postId}")             // å¾…å®ç°
    @PostMapping("/posts/{postId}/like")          // å¾…å®ç°
    @PostMapping("/posts/{postId}/collect")       // å¾…å®ç°
    
    // è¯„è®ºç›¸å…³
    @GetMapping("/posts/{postId}/comments")       // å¾…å®ç°
    @PostMapping("/posts/{postId}/comments")      // å¾…å®ç°
    @DeleteMapping("/posts/{postId}/comments/{commentId}")  // å¾…å®ç°
    
    // ä¸¾æŠ¥ç›¸å…³
    @PostMapping("/reports")                      // å¾…å®ç°
}
```

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] åˆ›å»º CreatePostDto
- [x] åˆ›å»º PostDetailVo
- [x] åˆ›å»º PostRepository
- [x] åˆ›å»º PostService å’Œ PostServiceImpl
- [x] åˆ›å»º CommunityControllerï¼ˆä¿®æ­£ï¼‰
- [x] æ›´æ–° Post å®ä½“ç±»
- [x] ä¿®æ­£æ¥å£è·¯å¾„ä¸º `/api/community`
- [x] å­—æ®µæ˜ å°„é€‚é…
- [x] ä¸šåŠ¡é€»è¾‘å®ç°
- [x] é”™è¯¯å¤„ç†
- [x] æ—¥å¿—è®°å½•
- [x] APIæ–‡æ¡£æ³¨é‡Š

---

## ğŸ“Š æ•°æ®åº“å½±å“

### æ¶‰åŠçš„è¡¨

1. **posts**: æ’å…¥æ–°å¸–å­è®°å½•
2. **users**: æ›´æ–°å‘å¸–æ•°ï¼ˆpost_countå­—æ®µï¼‰

### SQLç¤ºä¾‹

```sql
-- æ’å…¥å¸–å­
INSERT INTO posts (
    author_id, title, content, content_type, status,
    cover_image, media_urls, tags_json, country_code, category,
    like_count, comment_count, collect_count, view_count,
    is_pinned, is_featured, is_hot, allow_comment,
    published_at, created_at, updated_at, deleted
) VALUES (...);

-- æ›´æ–°ç”¨æˆ·å‘å¸–æ•°
UPDATE users SET post_count = post_count + 1 WHERE id = ?;
```

---

**å®ç°è€…**: AI Assistant  
**ç‰ˆæœ¬**: v2.0ï¼ˆå·²ä¿®æ­£ï¼‰  
**æ–‡æ¡£æ›´æ–°**: 2024-10-28

**ä¿®æ­£è¯´æ˜**: 
- æ ¹æ®`ç¤¾åŒºæ¨¡å—ä¿®æ”¹è¯´æ˜.md`çš„è¦æ±‚ä¿®æ­£äº†æ¥å£è·¯å¾„
- Controllerä»`PostController`é‡å‘½åä¸º`CommunityController`
- æ¥å£è·¯å¾„ä»`/api/posts`æ”¹ä¸º`/api/community/posts`
- ç°åœ¨å®Œå…¨ç¬¦åˆAPIæ¥å£æ–‡æ¡£çš„è§„èŒƒ âœ…

