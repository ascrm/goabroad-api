# 认证模块 API 接口文档

---
**版本**: v0.1.0  
**基础URL**: `http://localhost:8080/api`  
**模块**: 认证模块 (Auth)  
**最后修订**: 2024-10-29

---

## 通用说明

### 请求头规范

```http
Content-Type: application/json
Accept: application/json
satoken: {token_value}                # 需要认证的接口（Sa-Token认证）
```

**认证说明**:
- 本项目使用 Sa-Token 作为认证框架
- Token默认存储在请求头的 `satoken` 字段中
- Token有效期默认为30天（2592000秒）
- 登录/注册成功后会返回token，需要在后续需要认证的接口中携带

### 统一响应格式

#### 成功响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": { /* 具体数据，可能为null */ },
  "timestamp": 1698345600000
}
```

#### 失败响应

```json
{
  "code": 40001,
  "message": "该手机号已被注册",
  "data": null,
  "timestamp": 1698345600000
}
```

---

## 1. 认证模块 (Auth)

### 1.1 用户注册

**接口**: `POST /api/auth/register`  
**说明**: 手机号短信验证码注册  
**需要认证**: 否

#### 请求参数

```json
{
  "phone": "13800138000",
  "code": "123456",
  "password": "password123"
}
```

**参数说明**:
- `phone`: 手机号（必填，格式：1[3-9]开头的11位数字）
- `code`: 短信验证码（必填，6位数字）
- `password`: 密码（必填，长度6-20位）

#### 响应示例

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenName": "satoken",
    "tokenTimeout": 2592000
  },
  "timestamp": 1698345600000
}
```

**响应说明**:
- `token`: 访问令牌（Sa-Token）
- `tokenName`: Token名称（默认为satoken）
- `tokenTimeout`: Token有效期（秒），默认30天（2592000秒）
- 注册成功后会自动登录

### 1.2 用户登录

**接口**: `POST /api/auth/login`  
**说明**: 支持手机号或邮箱+密码登录  
**需要认证**: 否

#### 请求参数

```json
{
  "account": "13800138000",
  "password": "password123"
}
```

**参数说明**:
- `account`: 手机号或邮箱（必填）
- `password`: 密码（必填）

#### 响应示例

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "username": "user_1234567890_5678",
      "email": null,
      "phone": "138****8000",
      "nickname": "用户123456",
      "avatarUrl": null,
      "bio": null,
      "gender": null,
      "birthDate": null,
      "location": null,
      "postCount": 0,
      "followerCount": 0,
      "followingCount": 0,
      "status": "ACTIVE",
      "emailVerified": false,
      "phoneVerified": true,
      "lastLoginAt": "2024-10-25T10:00:00",
      "lastLoginIp": "192.168.1.1",
      "createdAt": "2024-10-25T10:00:00",
      "updatedAt": "2024-10-25T10:00:00"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenName": "satoken",
    "tokenTimeout": 2592000
  },
  "timestamp": 1698345600000
}
```

**🔧 [已修正 - 重要]**: 
- 移除 level, points, exp（数据库users表无这些字段）
- 移除 isVip, vipExpireAt（数据库users表无这些字段）
- 添加 birthDate, location, lastLoginIp（数据库users表有这些字段）
- 所有字段与数据库users表结构完全一致

**响应说明**:
- `user`: 用户信息对象
  - `id`: 用户ID（Long类型）
  - `username`: 用户名（自动生成，格式：user_时间戳_随机数）
  - `email`: 邮箱（已脱敏，可能为null）
  - `phone`: 手机号（已脱敏）
  - `nickname`: 昵称（自动生成，格式：用户+6位随机数）
  - `status`: 账号状态（ACTIVE/INACTIVE/BANNED/DELETED）
  - `gender`: 性别（MALE/FEMALE/OTHER/PREFER_NOT_TO_SAY）
  - `phoneVerified`: 手机号是否已验证
  - `emailVerified`: 邮箱是否已验证
- `token`: 访问令牌
- `tokenName`: Token名称
- `tokenTimeout`: Token有效期（秒）

### 1.3 发送短信验证码

**接口**: `GET /api/auth/send-sms-code`  
**说明**: 发送短信验证码（用于注册）  
**需要认证**: 否

#### 请求参数

```
phone: 13800138000  // 手机号（必填）
```

**Query参数说明**:
- `phone`: 手机号（必填，格式：1[3-9]开头的11位数字）

#### 响应示例

```json
{
  "code": 200,
  "message": "验证码已发送，请查收短信",
  "data": null,
  "timestamp": 1698345600000
}
```

**功能说明**:
- 验证码为6位数字
- 有效期为5分钟
- 验证码会保存在Redis中
- 开发环境下验证码会打印在控制台日志中

### 1.4 用户登出

**接口**: `POST /api/auth/logout`  
**说明**: 退出登录，使当前token失效  
**需要认证**: 是

#### 请求头

```http
satoken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 请求参数

无

#### 响应示例

```json
{
  "code": 200,
  "message": "登出成功",
  "data": null,
  "timestamp": 1698345600000
}
```

**功能说明**:
- 会清除用户的登录状态
- Token会立即失效
- 需要在请求头中携带有效的Token

### 1.5 其他认证接口（待实现）

以下接口暂未实现，将在后续版本中提供：

- 请求重置密码
- 重置密码
- 修改密码
- 第三方登录（微信、Apple）
- 检查邮箱是否存在
- 检查手机号是否存在
- 获取当前用户信息
- 手机号验证码快捷登录
- Token刷新

---

## 错误码说明

### 通用状态码

| 错误码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（未登录或Token失效）|
| 403 | 无权限访问 |
| 422 | 参数验证失败 |
| 429 | 请求过于频繁 |
| 500 | 系统错误 |

### 用户相关错误码 (40xxx)

| 错误码 | 说明 |
|--------|------|
| 40001 | 用户不存在 |
| 40002 | 用户已存在 |
| 40003 | 密码错误 |
| 40004 | 用户已被禁用 |
| 40005 | 用户名或密码错误 |

### 认证相关错误码 (41xxx)

| 错误码 | 说明 |
|--------|------|
| 41001 | 未登录或Token失效 |
| 41002 | Token已过期 |
| 41003 | Token无效 |
| 41004 | 无权限访问 |

### 验证相关错误码 (45xxx)

| 错误码 | 说明 |
|--------|------|
| 45001 | 验证码错误 |
| 45002 | 验证码已过期 |
| 45003 | 验证码发送失败 |

---

## 更新日志

### v0.1.0 (2024-10-25)
- 初始版本发布
- 实现用户注册（手机号）
- 实现用户登录
- 实现用户登出
- 实现发送短信验证码
- 集成 Sa-Token 认证框架

---

**文档结束**

