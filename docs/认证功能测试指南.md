# 🧪 GoAbroad 认证功能测试指南

---

## 📋 功能概述

已完成的认证功能包括：
- ✅ 用户注册
- ✅ 用户登录
- ✅ 用户登出
- ✅ Token 刷新
- ✅ 发送验证码
- ✅ 重置密码
- ✅ Token 验证

---

## 🚀 启动项目

### 1. 环境准备

确保以下服务正常运行：
- ✅ MySQL 8.0（端口 3307）
- ✅ Redis 7.0（端口 6379）

### 2. 启动应用

```bash
cd goabroad-web
mvn spring-boot:run
```

或在 IDE 中运行 `GoAbroadApplication` 主类。

### 3. 访问 Swagger 文档

打开浏览器访问：
```
http://localhost:8080/swagger-ui/index.html
```

---

## 🧪 接口测试

### 1. 用户注册

**接口**: `POST /api/v1/auth/register`

**请求示例**:
```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "123456",
  "nickname": "测试用户"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "nickname": "测试用户",
      "level": 1,
      "points": 0,
      "status": "ACTIVE"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenName": "Authorization",
    "tokenTimeout": 2592000
  },
  "timestamp": 1729497600000
}
```

**验证规则**:
- ✅ 用户名：3-20位字母、数字、下划线
- ✅ 邮箱：符合邮箱格式
- ✅ 密码：6-20位

---

### 2. 用户登录

**接口**: `POST /api/v1/auth/login`

**请求示例**:
```json
{
  "username": "testuser",
  "password": "123456"
}
```

**说明**: `username` 字段可以是用户名或邮箱

**响应示例**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "nickname": "测试用户",
      "level": 1,
      "points": 0
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenName": "Authorization",
    "tokenTimeout": 2592000
  },
  "timestamp": 1729497600000
}
```

---

### 3. 用户登出

**接口**: `POST /api/v1/auth/logout`

**请求头**:
```
Authorization: {token}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "登出成功",
  "data": null,
  "timestamp": 1729497600000
}
```

---

### 4. Token 验证

**接口**: `GET /api/v1/auth/validate`

**请求头**:
```
Authorization: {token}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "isValid": true,
    "userId": 1,
    "tokenTimeout": 2592000
  },
  "timestamp": 1729497600000
}
```

---

### 5. 发送验证码

**接口**: `POST /api/v1/auth/send-code?email=test@example.com`

**响应示例**:
```json
{
  "code": 200,
  "message": "验证码已发送，请查收邮箱",
  "data": null,
  "timestamp": 1729497600000
}
```

**说明**: 
- 验证码会打印在日志中（实际生产环境应该发送邮件）
- 验证码有效期：5分钟

---

### 6. 重置密码

**接口**: `POST /api/v1/auth/reset-password`

**请求参数**:
```
email=test@example.com&code=123456&newPassword=newpass123
```

**响应示例**:
```json
{
  "code": 200,
  "message": "密码重置成功，请重新登录",
  "data": null,
  "timestamp": 1729497600000
}
```

---

## 🧪 测试场景

### 场景 1: 完整注册登录流程

1. **注册新用户**
   ```bash
   POST /api/v1/auth/register
   {
     "username": "alice",
     "email": "alice@example.com",
     "password": "123456",
     "nickname": "爱丽丝"
   }
   ```

2. **复制返回的 token**

3. **访问需要认证的接口** (使用 token)
   ```bash
   GET /api/v1/auth/me
   Header: Authorization: {token}
   ```

4. **登出**
   ```bash
   POST /api/v1/auth/logout
   Header: Authorization: {token}
   ```

---

### 场景 2: 测试重复注册

1. 注册用户 `bob`
2. 再次使用相同用户名注册
3. 预期结果：返回 "用户名已被注册"

---

### 场景 3: 测试密码错误

1. 注册用户 `charlie`
2. 使用错误密码登录
3. 预期结果：返回 "用户名或密码错误"

---

### 场景 4: 测试 Token 过期

1. 登录获取 token
2. 修改配置使 token 立即过期
3. 使用过期 token 访问接口
4. 预期结果：返回 "登录已过期，请重新登录"

---

### 场景 5: 测试密码重置

1. 发送验证码到邮箱
   ```bash
   POST /api/v1/auth/send-code?email=test@example.com
   ```

2. 查看日志获取验证码

3. 使用验证码重置密码
   ```bash
   POST /api/v1/auth/reset-password
   email=test@example.com&code=123456&newPassword=newpass123
   ```

4. 使用新密码登录

---

## 🔍 错误码说明

| 错误码 | 说明 |
|-------|------|
| 200 | 成功 |
| 400 | 参数错误 |
| 401 | 未登录或Token无效 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

---

## 📊 验证检查清单

### 功能验证
- [ ] 用户可以成功注册
- [ ] 用户可以使用用户名登录
- [ ] 用户可以使用邮箱登录
- [ ] 密码会被加密存储（BCrypt）
- [ ] Token 在登录后生成
- [ ] Token 在登出后失效
- [ ] 验证码会正确生成和验证
- [ ] 密码可以成功重置

### 异常处理验证
- [ ] 用户名重复会提示错误
- [ ] 邮箱重复会提示错误
- [ ] 密码错误会提示错误
- [ ] 参数格式错误会提示验证失败
- [ ] 未登录访问需认证接口会返回 401
- [ ] Token 过期会返回相应提示

### 安全性验证
- [ ] 密码以 BCrypt 加密存储
- [ ] 登录失败不会泄露用户是否存在
- [ ] Token 包含用户ID
- [ ] Token 可以正常过期
- [ ] 验证码有时效性（5分钟）

---

## 🐛 常见问题

### 1. 启动失败：无法连接 MySQL

**解决方案**:
- 检查 MySQL 是否在 3307 端口运行
- 检查用户名密码是否正确（application.yml）
- 检查数据库 `goabroad_db` 是否存在

### 2. 启动失败：无法连接 Redis

**解决方案**:
- 检查 Redis 是否在 6379 端口运行
- 检查 Redis 密码配置

### 3. MapStruct 编译错误

**解决方案**:
```bash
mvn clean compile
```

### 4. Swagger 页面无法访问

**解决方案**:
- 检查项目是否成功启动
- 访问 http://localhost:8080/swagger-ui/index.html
- 检查端口 8080 是否被占用

---

## 📝 后续优化建议

1. **邮件服务集成**: 集成真实的邮件服务发送验证码
2. **短信验证码**: 支持手机号注册和短信验证码
3. **第三方登录**: 集成微信、QQ 登录
4. **图形验证码**: 防止机器人恶意注册
5. **登录日志**: 记录用户登录历史
6. **多设备管理**: 查看和管理登录设备
7. **单点登录（SSO）**: 跨应用登录

---

## ✅ 测试完成标志

当以下所有项都通过时，认证功能测试完成：

- [x] 用户注册接口正常工作
- [x] 用户登录接口正常工作  
- [x] Token 生成和验证正常
- [x] 密码加密存储
- [x] 全局异常处理生效
- [x] Swagger 文档可访问
- [ ] 所有测试场景通过
- [ ] 无严重 Bug

---

**测试人员**: ___________  
**测试日期**: ___________  
**测试结果**: ⭕ 通过 / ❌ 未通过

---

**祝测试顺利！🎉**

