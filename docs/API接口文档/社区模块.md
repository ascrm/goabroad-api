# 社区模块 (Community)

## 5.1 获取帖子列表

**接口**: `GET /community/posts`  
**说明**: 获取帖子列表（支持筛选）  
**需要认证**: 否（登录后可看到个性化推荐）

### Query 参数

```
tab: recommend | following | country | stage  # Tab类型
country: US | UK | CA ...                    # 国家筛选
stage: preparation | applying | waiting ...   # 阶段筛选
type: POST | QUESTION | TIMELINE | VLOG      # 内容类型
sort: latest | hot | recommended             # 排序方式
page: 页码
pageSize: 每页数量
```

### 响应示例

```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "items": [
      {
        "id": 123,
        "author": {
          "id": 1,
          "nickname": "GoAbroad小新",
          "avatarUrl": "https://cdn.goabroad.com/avatars/1.jpg"
        },
        "contentType": "POST",
        "title": "美国F1签证面签经验分享",
        "summary": "今天刚刚通过面签，分享一下经验...",
        "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
        "mediaUrls": [
          "https://cdn.goabroad.com/posts/img1.jpg",
          "https://cdn.goabroad.com/posts/img2.jpg"
        ],
        "tags": "美国,签证,F1,面签经验",
        "likeCount": 125,
        "commentCount": 32,
        "collectCount": 85,
        "viewCount": 1520,
        "isLiked": false,
        "isCollected": false,
        "isPinned": false,
        "isFeatured": true,
        "status": "PUBLISHED",
        "createdAt": "2024-10-20T10:00:00",
        "updatedAt": "2024-10-20T10:00:00"
      },
      {
        "id": 124,
        "author": {
          "id": 2,
          "nickname": "留学小白",
          "avatarUrl": "https://cdn.goabroad.com/avatars/2.jpg"
        },
        "contentType": "QUESTION",
        "title": "请问英国读研需要准备多少钱？",
        "summary": "打算明年去英国读研，不知道需要准备多少钱...",
        "tags": "英国,留学,费用",
        "likeCount": 15,
        "commentCount": 8,
        "collectCount": 5,
        "viewCount": 280,
        "isLiked": false,
        "isCollected": false,
        "status": "PUBLISHED",
        "createdAt": "2024-10-24T16:30:00",
        "updatedAt": "2024-10-24T16:30:00"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 20,
      "totalItems": 1520,
      "totalPages": 76,
      "hasNext": true,
      "hasPrevious": false,
      "isFirstPage": true,
      "isLastPage": false
    }
  }
}
```

**🔧 [已修正 - 重要]**:
- 帖子ID和作者ID改为数字类型
- avatar改为avatarUrl
- 移除author.level（数据库users表无此字段）
- images改为mediaUrls（对应数据库posts表的media_urls JSONB字段）
- content和contentPreview合并为summary（列表只显示摘要）
- 移除country和stage字段（数据库posts表无此字段，可从category或metadata获取）
- tags从数组改为逗号分隔的字符串（与数据库VARCHAR类型一致）
- 添加status字段（数据库有此字段：DRAFT/PUBLISHED/DELETED）
- 添加updatedAt字段
- pagination改为统一格式
- 时间格式去掉Z后缀

---

## 5.2 获取帖子详情

**接口**: `GET /community/posts/:postId`  
**说明**: 获取帖子详情  
**需要认证**: 否

### 响应示例

```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": 123,
    "author": {
      "id": 1,
      "nickname": "GoAbroad小新",
      "avatarUrl": "https://cdn.goabroad.com/avatars/1.jpg",
      "bio": "正在准备美国留学",
      "postCount": 25,
      "followerCount": 120,
      "isFollowing": false
    },
    "contentType": "POST",
    "title": "美国F1签证面签经验分享",
    "content": "# 前言\n\n今天刚刚通过面签...\n\n## 准备材料\n\n1. 护照\n2. I-20...",
    "status": "PUBLISHED",
    "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
    "mediaUrls": [
      "https://cdn.goabroad.com/posts/img1.jpg",
      "https://cdn.goabroad.com/posts/img2.jpg"
    ],
    "tags": "美国,签证,F1,面签经验",
    "likeCount": 125,
    "commentCount": 32,
    "collectCount": 85,
    "viewCount": 1521,
    "isLiked": false,
    "isCollected": false,
    "isPinned": false,
    "isFeatured": true,
    "createdAt": "2024-10-20T10:00:00",
    "updatedAt": "2024-10-20T10:00:00"
  }
}
```

**🔧 [已修正 - 重要]**:
- 帖子ID和作者ID改为数字类型
- avatar改为avatarUrl
- 移除author.level（数据库users表无此字段）
- 直接使用postCount、followerCount（与数据库users字段一致）
- images改为mediaUrls（对应数据库posts表的media_urls JSONB字段）
- 移除videos（数据库posts表无此字段，视频也存储在media_urls中）
- tags改为逗号分隔字符串（与数据库posts表一致）
- 移除country、countryName、stage（数据库posts表无这些独立字段，可从category或通过country_code关联查询）
- 移除relatedPosts（应通过单独接口查询）
- 时间格式去掉Z后缀

---

## 5.3 发布帖子

**接口**: `POST /community/posts`  
**说明**: 发布新帖子  
**需要认证**: 是

### 请求参数

```json
{
  "contentType": "POST",
  "title": "美国F1签证面签经验分享",
  "content": "# 前言\n\n今天刚刚通过面签...",
  "summary": "今天刚刚通过面签，分享一下经验...",
  "status": "PUBLISHED",
  "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
  "mediaUrls": [
    "https://cdn.goabroad.com/posts/img1.jpg",
    "https://cdn.goabroad.com/posts/img2.jpg"
  ],
  "tags": "美国,签证,F1,面签经验",
  "countryCode": "US",
  "category": "签证"
}
```

**🔧 [已修正 - 重要]**: 
- 添加summary字段（数据库有此字段，用于列表展示）
- images改为mediaUrls（对应数据库posts表的media_urls JSONB字段）
- tags改为逗号分隔字符串（与数据库一致）
- 添加countryCode和category字段（数据库posts表有这些字段）
- status为DRAFT/PUBLISHED/DELETED之一

### 响应示例

```json
{
  "code": 200,
  "message": "发布成功",
  "data": {
    "id": 125,
    "authorId": 1,
    "contentType": "POST",
    "title": "美国F1签证面签经验分享",
    "summary": "今天刚刚通过面签，分享一下经验...",
    "content": "# 前言\n\n今天刚刚通过面签...",
    "status": "PUBLISHED",
    "coverImage": "https://cdn.goabroad.com/posts/cover-123.jpg",
    "mediaUrls": [
      "https://cdn.goabroad.com/posts/img1.jpg",
      "https://cdn.goabroad.com/posts/img2.jpg"
    ],
    "tags": "美国,签证,F1",
    "countryCode": "US",
    "category": "签证",
    "likeCount": 0,
    "commentCount": 0,
    "collectCount": 0,
    "viewCount": 0,
    "shareCount": 0,
    "isPinned": false,
    "isFeatured": false,
    "isHot": false,
    "allowComment": true,
    "createdAt": "2024-10-25T16:00:00",
    "updatedAt": "2024-10-25T16:00:00",
    "publishedAt": "2024-10-25T16:00:00"
  }
}
```

**🔧 [已修正 - 重要]**: 
- ID改为数字类型
- 添加authorId（返回作者ID而非完整author对象）
- images改为mediaUrls
- tags改为字符串
- 添加countryCode和category字段
- 添加数据库posts表的完整字段（shareCount, isHot, allowComment, publishedAt）

---

## 5.4 编辑帖子

**接口**: `PUT /community/posts/:postId`  
**说明**: 编辑已发布的帖子  
**需要认证**: 是（仅作者可编辑）

### 请求参数

```json
{
  "title": "更新后的标题",
  "content": "更新后的内容",
  "images": [],
  "tags": ["更新", "标签"]
}
```

---

## 5.5 删除帖子

**接口**: `DELETE /community/posts/:postId`  
**说明**: 删除帖子  
**需要认证**: 是（仅作者可删除）

---

## 5.6 点赞帖子

**接口**: `POST /community/posts/:postId/like`  
**说明**: 点赞或取消点赞帖子（toggle）  
**需要认证**: 是

### 响应示例

```json
{
  "code": 200,
  "message": "点赞成功",
  "data": {
    "isLiked": true,
    "likeCount": 126
  }
}
```

---

## 5.7 收藏帖子

**接口**: `POST /community/posts/:postId/collect`  
**说明**: 收藏或取消收藏帖子（toggle）  
**需要认证**: 是

### 响应示例

```json
{
  "code": 200,
  "message": "收藏成功",
  "data": {
    "isCollected": true,
    "collectCount": 86
  }
}
```

---

## 5.8 获取评论列表

**接口**: `GET /community/posts/:postId/comments`  
**说明**: 获取帖子的评论列表  
**需要认证**: 否

### Query 参数

```
sort: latest | hot        # 排序方式
page: 页码
pageSize: 每页数量
```

### 响应示例

```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "items": [
      {
        "id": 123,
        "postId": 123,
        "author": {
          "id": 456,
          "nickname": "热心网友",
          "avatarUrl": "https://cdn.goabroad.com/avatars/456.jpg"
        },
        "content": "非常有用的分享，感谢！",
        "likeCount": 15,
        "replyCount": 2,
        "isLiked": false,
        "parentId": null,
        "rootId": null,
        "status": "VISIBLE",
        "replies": [
          {
            "id": 124,
            "postId": 123,
            "author": {
              "id": 1,
              "nickname": "GoAbroad小新",
              "avatarUrl": "https://cdn.goabroad.com/avatars/1.jpg"
            },
            "content": "不客气，祝你好运！",
            "likeCount": 5,
            "isLiked": false,
            "parentId": 123,
            "rootId": 123,
            "status": "VISIBLE",
            "createdAt": "2024-10-20T11:00:00",
            "updatedAt": "2024-10-20T11:00:00"
          }
        ],
        "createdAt": "2024-10-20T10:30:00",
        "updatedAt": "2024-10-20T10:30:00"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 20,
      "totalItems": 32,
      "totalPages": 2,
      "hasNext": true,
      "hasPrevious": false,
      "isFirstPage": true,
      "isLastPage": false
    }
  }
}
```

**🔧 [已修正 - 重要]**:
- 所有ID改为数字类型（commentId, postId, userId）
- avatar改为avatarUrl
- 移除author.level（数据库users表无此字段）
- 移除images字段（数据库comments表无此字段）
- 移除replyToUserId字段（数据库comments表无此字段，通过parentId判断回复关系）
- 添加rootId字段（数据库comments表有此字段，用于快速定位根评论）
- status字段为VISIBLE/HIDDEN/DELETED（与数据库一致，不是APPROVED/PENDING/REJECTED）
- 添加updatedAt字段
- pagination改为统一格式
- 时间格式去掉Z后缀

---

## 5.9 发表评论

**接口**: `POST /community/posts/:postId/comments`  
**说明**: 发表评论或回复  
**需要认证**: 是

### 请求参数

```json
{
  "content": "非常有用的分享，感谢！",
  "parentId": null,
  "rootId": null
}
```

**🔧 [已修正 - 重要]**: 
- 移除replyToUserId字段（数据库comments表无此字段）
- 添加rootId字段（数据库comments表有此字段，用于标识根评论）

### 响应示例

```json
{
  "code": 200,
  "message": "评论成功",
  "data": {
    "id": 125,
    "postId": 123,
    "authorId": 1,
    "content": "非常有用的分享，感谢！",
    "likeCount": 0,
    "replyCount": 0,
    "parentId": null,
    "rootId": null,
    "status": "VISIBLE",
    "createdAt": "2024-10-25T16:30:00",
    "updatedAt": "2024-10-25T16:30:00"
  }
}
```

**🔧 [已修正 - 重要]**: 
- ID改为数字类型
- userId改为authorId（与数据库author_id字段一致）
- 移除replyToUserId字段（数据库comments表无此字段）
- 添加rootId字段（数据库comments表有此字段）
- status改为VISIBLE（与数据库一致，不是APPROVED）

---

## 5.10 删除评论

**接口**: `DELETE /community/posts/:postId/comments/:commentId`  
**说明**: 删除评论  
**需要认证**: 是（仅作者可删除）

---

## 5.11 点赞评论

**接口**: `POST /community/posts/:postId/comments/:commentId/like`  
**说明**: 点赞或取消点赞评论（toggle）  
**需要认证**: 是

---

## 5.12 举报帖子/评论

**接口**: `POST /community/reports`  
**说明**: 举报违规内容  
**需要认证**: 是

### 请求参数

```json
{
  "type": "post",  // post, comment
  "targetId": "post-123",
  "reason": "spam",  // spam, inappropriate, false_info, other
  "description": "详细说明..."
}
```

---

## 数据模型

### 帖子简要信息 (PostSimpleVo)

```typescript
interface PostSimpleVo {
  id: number;
  author: {
    id: number;
    nickname: string;
    avatarUrl?: string;
  };
  contentType: 'POST' | 'QUESTION' | 'TIMELINE' | 'VLOG';
  title: string;
  summary: string;
  coverImage?: string;
  mediaUrls?: any[];  // JSONB类型，可存储图片、视频等多媒体URL
  tags: string;  // 逗号分隔的字符串（与数据库VARCHAR一致）
  countryCode?: string;  // 关联国家代码
  category?: string;
  likeCount: number;
  commentCount: number;
  collectCount: number;
  viewCount: number;
  shareCount: number;
  isLiked: boolean;
  isCollected: boolean;
  isPinned: boolean;
  isFeatured: boolean;
  isHot: boolean;
  status: 'DRAFT' | 'PUBLISHED' | 'DELETED';  // 与数据库一致
  createdAt: string;
  updatedAt: string;
}
```

**说明**: 与数据库posts表字段完全一致，移除author.level，images改为mediaUrls

### 帖子详细信息 (PostDetailVo)

```typescript
interface PostDetailVo {
  id: number;
  author: {
    id: number;
    nickname: string;
    avatarUrl?: string;
    bio?: string;
    postCount: number;
    followerCount: number;
    isFollowing: boolean;
  };
  contentType: 'POST' | 'QUESTION' | 'TIMELINE' | 'VLOG';
  title: string;
  content: string;  // Markdown格式
  summary?: string;
  status: 'DRAFT' | 'PUBLISHED' | 'DELETED';  // 与数据库一致
  coverImage?: string;
  mediaUrls?: any[];  // JSONB类型
  tags: string;  // 逗号分隔的字符串
  countryCode?: string;
  category?: string;
  likeCount: number;
  commentCount: number;
  collectCount: number;
  viewCount: number;
  shareCount: number;
  isLiked: boolean;
  isCollected: boolean;
  isPinned: boolean;
  isFeatured: boolean;
  isHot: boolean;
  allowComment: boolean;
  slug?: string;
  createdAt: string;
  updatedAt: string;
  publishedAt?: string;
}
```

**说明**: 与数据库posts表字段完全一致，移除author.level，添加数据库实际字段

### 评论信息 (Comment)

```typescript
interface Comment {
  id: number;
  postId: number;
  author: {
    id: number;
    nickname: string;
    avatarUrl?: string;
  };
  content: string;
  likeCount: number;
  replyCount: number;
  isLiked: boolean;
  parentId?: number;  // 父评论ID
  rootId?: number;  // 根评论ID（数据库有此字段）
  status: 'VISIBLE' | 'HIDDEN' | 'DELETED';  // 与数据库一致
  replies?: Comment[];  // 子评论列表
  createdAt: string;
  updatedAt: string;
}
```

**说明**: 与数据库comments表字段完全一致，移除replyToUserId（数据库无此字段），添加rootId，status与数据库枚举值一致

---

## 错误码说明

### 帖子相关错误码 (42xxx)

| 错误码 | 说明 |
|--------|------|
| 42001 | 帖子不存在 |
| 42002 | 帖子已被删除 |
| 42003 | 无权限操作该帖子 |

### 评论相关错误码 (43xxx)

| 错误码 | 说明 |
|--------|------|
| 43001 | 评论不存在 |
| 43002 | 评论已被删除 |
| 43003 | 无权限操作该评论 |

---

## 业务规则说明

### 内容类型说明

- **POST**: 普通分享帖子（经验分享、攻略等）
- **QUESTION**: 问答帖子
- **TIMELINE**: 时间线动态（简短的状态更新）
- **VLOG**: 视频日志（包含视频内容）

### 帖子状态说明

- **DRAFT**: 草稿（未发布）
- **PUBLISHED**: 已发布（公开可见）
- **DELETED**: 已删除（软删除）

**注意**: 与数据库posts表status字段完全一致

### 评论状态说明

- **VISIBLE**: 可见（正常显示）
- **HIDDEN**: 已隐藏（管理员操作）
- **DELETED**: 已删除（软删除）

**注意**: 与数据库comments表status字段完全一致

### 点赞/收藏规则

- 点赞和收藏接口都采用 toggle 模式
- 已点赞/收藏再次调用会取消
- 未点赞/收藏调用会添加

### 评论回复规则

- `parentId` 为 null 表示一级评论（顶级评论）
- `parentId` 有值表示回复评论（子评论）
- `rootId` 指向根评论的ID，方便查询整个评论楼层
- 数据库通过 parentId 和 rootId 实现评论的树形结构

---

**文档版本**: v0.1.0  
**最后更新**: 2024-10-29

