# 问答功能实现说明

## 更新日期
2024-11-05

## 问题背景

在原有的帖子表设计中，虽然有 `content_type` 字段可以区分 `QUESTION` 和 `POST`，但是**没有字段来关联"回答"和"问题"**，导致无法查询某个问题下有哪些回答。

## 解决方案

通过在 `posts` 表中添加 `parent_post_id` 字段来建立问答关联关系：

- **问题帖子**：`parent_post_id` 为 `NULL`，`content_type` 为 `QUESTION`
- **回答帖子**：`parent_post_id` 指向问题帖子的 ID，`content_type` 为 `POST`

## 修改内容

### 1. 数据库层面

#### 1.1 DDL 修改

**文件：** `docs/database/database_ddl.sql`

**新增字段：**
- `parent_post_id BIGINT` - 父帖子ID（回答帖子关联到问题帖子）
- `answer_count INTEGER DEFAULT 0` - 回答数（仅问题帖子有效，冗余字段提升性能）

**新增索引：**
- `idx_posts_parent_post_id` - 优化查询某个问题的所有回答

**外键约束：**
```sql
CONSTRAINT fk_posts_parent FOREIGN KEY (parent_post_id) REFERENCES posts(id) ON DELETE CASCADE
```

#### 1.2 数据库迁移脚本

**文件：** `docs/database/migrations/001_add_parent_post_id_to_posts.sql`

包含完整的 ALTER TABLE 语句和回滚脚本。

### 2. 实体类层面

#### 2.1 Post 实体

**文件：** `goabroad-model/src/main/java/com/goabroad/model/community/post/entity/Post.java`

**新增字段：**
```java
@Column(name = "parent_post_id")
private Long parentPostId;

@Column(name = "answer_count", nullable = false)
@Builder.Default
private Integer answerCount = 0;
```

**新增索引：**
```java
@Index(name = "idx_parent_post_id", columnList = "parent_post_id")
```

### 3. VO 层面

#### 3.1 PostSimpleVo

**文件：** `goabroad-model/src/main/java/com/goabroad/model/community/post/vo/PostSimpleVo.java`

**新增字段：**
```java
@Schema(description = "父帖子ID（回答帖子关联到问题帖子）")
private Long parentPostId;

@Schema(description = "回答数（仅问题帖子有效）", example = "15")
private Integer answerCount;
```

#### 3.2 PostDetailVo

**文件：** `goabroad-model/src/main/java/com/goabroad/model/community/post/vo/PostDetailVo.java`

**新增字段：**
```java
@Schema(description = "父帖子ID（回答帖子关联到问题帖子）", example = "123")
private Long parentPostId;

@Schema(description = "回答数（仅问题帖子有效）", example = "15")
private Integer answerCount;
```

### 4. DTO 层面

#### 4.1 CreatePostDto

**文件：** `goabroad-model/src/main/java/com/goabroad/model/community/post/dto/CreatePostDto.java`

**新增字段：**
```java
@Schema(description = "父帖子ID（创建回答帖子时必填，问题帖子无需填写）", 
        example = "123",
        requiredMode = Schema.RequiredMode.NOT_REQUIRED)
private Long parentPostId;
```

### 5. 转换器层面

#### 5.1 PostConverter

**文件：** `goabroad-model/src/main/java/com/goabroad/model/community/post/converter/PostConverter.java`

**新增映射：**
```java
@Mapping(target = "parentPostId", source = "dto.parentPostId")
```

确保 `parentPostId` 在 DTO 转 Entity 时被正确映射。

### 6. API 文档

**文件：** `docs/API接口文档/社区模块.md`

新增完整的问答功能说明，包括：
- 功能概述
- 数据库设计说明
- 使用场景示例（发布问题、回答问题、查询回答）
- 业务规则
- 注意事项

## 使用示例

### 场景1：发布问题

```bash
POST /api/community/posts
Content-Type: application/json
satoken: <用户token>

{
  "contentType": "QUESTION",
  "title": "托福成绩100分能申请到什么学校？",
  "content": "本人托福100，GPA 3.5，想申请美国CS专业硕士...",
  "category": "留学",
  "tags": ["留学", "美国", "托福", "CS"]
}
```

### 场景2：回答问题

```bash
POST /api/community/posts
Content-Type: application/json
satoken: <用户token>

{
  "contentType": "POST",
  "parentPostId": 123,
  "content": "根据你的条件，我建议可以申请以下学校：\n\n1. University of Washington...",
  "category": "留学",
  "tags": ["留学", "美国", "学校推荐"]
}
```

### 场景3：查询某个问题的所有回答

```bash
GET /api/community/posts?parentPostId=123&page=0&size=20
```

## 数据库查询示例

### 查询某个问题的所有回答
```sql
SELECT * FROM posts 
WHERE parent_post_id = 123 
  AND status = 'PUBLISHED' 
  AND deleted = false
ORDER BY created_at DESC;
```

### 统计问题的回答数
```sql
SELECT COUNT(*) FROM posts 
WHERE parent_post_id = 123 
  AND status = 'PUBLISHED' 
  AND deleted = false;
```

### 查询热门问题（按回答数排序）
```sql
SELECT * FROM posts 
WHERE content_type = 'QUESTION' 
  AND status = 'PUBLISHED' 
  AND deleted = false
ORDER BY answer_count DESC, created_at DESC
LIMIT 20;
```

## 性能优化

1. **索引优化**
   - `idx_posts_parent_post_id` 索引加速回答查询
   - 外键约束确保数据一致性

2. **冗余字段**
   - `answer_count` 字段避免每次都 COUNT 统计
   - 需要在创建/删除回答时同步更新

3. **级联删除**
   - 删除问题时自动删除所有回答
   - 通过数据库外键约束实现

## 注意事项

1. ⚠️ **创建回答时验证**
   - 必须确保 `parentPostId` 指向的帖子存在
   - 必须确保父帖子的类型为 `QUESTION`

2. ⚠️ **不支持多层嵌套**
   - 回答帖子不能再有子回答
   - 如需讨论回答，请使用评论功能

3. ⚠️ **数据一致性**
   - `answer_count` 由系统维护，不接受手动设置
   - 创建回答时 +1，删除回答时 -1

4. ⚠️ **数据迁移**
   - 现有数据的 `parent_post_id` 默认为 `NULL`
   - 现有数据的 `answer_count` 默认为 `0`

## 后续开发建议

1. **Service 层实现**
   - 在 `PostService` 中添加验证逻辑
   - 创建回答时验证父帖子存在且为问题类型
   - 维护 `answer_count` 字段的同步更新

2. **查询优化**
   - 在 `PostRepository` 添加 `findByParentPostId` 方法
   - 支持按回答数排序的热门问题查询

3. **通知功能**
   - 当有人回答问题时，通知提问者
   - 使用 `notifications` 表记录

4. **采纳功能**（可选）
   - 提问者可以采纳最佳回答
   - 在 Post 表添加 `is_accepted` 字段

## 相关文件清单

### 数据库
- `docs/database/database_ddl.sql`
- `docs/database/migrations/001_add_parent_post_id_to_posts.sql`

### 实体类
- `goabroad-model/src/main/java/com/goabroad/model/community/post/entity/Post.java`

### VO
- `goabroad-model/src/main/java/com/goabroad/model/community/post/vo/PostSimpleVo.java`
- `goabroad-model/src/main/java/com/goabroad/model/community/post/vo/PostDetailVo.java`

### DTO
- `goabroad-model/src/main/java/com/goabroad/model/community/post/dto/CreatePostDto.java`

### 转换器
- `goabroad-model/src/main/java/com/goabroad/model/community/post/converter/PostConverter.java`

### 文档
- `docs/API接口文档/社区模块.md`
- `docs/功能更新/问答功能实现说明.md`（本文档）

## 总结

通过添加 `parent_post_id` 和 `answer_count` 两个字段，成功实现了帖子表的问答关联功能。设计简洁高效，支持快速查询问题的所有回答，同时通过冗余字段和索引优化了性能。

